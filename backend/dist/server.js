!function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},o.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=20)}([function(e,t){e.exports=require("mongoose")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.error=function(e,t){return{type:"error",message:e,code:t}},e.success=function(e){return{type:"success",data:e,code:200}},e.error2=function(e,t){return{type:"error",message:e,code:t}}}(t.JsonResponse||(t.JsonResponse={}))},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))(function(r,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function u(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){e.done?r(e.value):new o(function(t){t(e.value)}).then(s,u)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=o(1);t.Repository=class{constructor(e){this.model=e,this.create=this.create.bind(this),this.updateById=this.updateById.bind(this),this.read=this.read.bind(this),this.remove=this.remove.bind(this)}create(e){return n(this,void 0,void 0,function*(){let t=new(0,this.model)(e);try{let e=yield this.model.create(t);return r.JsonResponse.success(e)}catch(e){return r.JsonResponse.error2(e,500)}})}updateById(e,t){return n(this,void 0,void 0,function*(){try{let o=yield this.model.updateOne({_id:e},t);return r.JsonResponse.success(o)}catch(e){return r.JsonResponse.error2(e,500)}})}read(e){return n(this,void 0,void 0,function*(){try{let t=yield this.model.findById(e);return r.JsonResponse.success(t)}catch(e){return r.JsonResponse.error2(e,500)}})}remove(e){return n(this,void 0,void 0,function*(){try{let t=yield this.model.findOneAndRemove({_id:e});return r.JsonResponse.success(t)}catch(e){return r.JsonResponse.error2(e,500)}})}}},function(e,t){e.exports=require("request")},function(e,t){e.exports=require("youtube-dl")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("gridfs-stream")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(0);var r;!function(e){e.SPOTIFY="spotify",e.UPLOAD="upload",e.LINK="link"}(r=t.SongType||(t.SongType={}));let i=new n.Schema({name:{type:String,required:!0},image_cover:{type:String,default:"default.png"},artists:{type:[String],required:!0},type:{type:String,enum:[r.LINK,r.SPOTIFY,r.UPLOAD],required:!0},duration_ms:{type:Number,required:!0,min:0},uri:{type:String,required:!1},file_id:{type:n.Schema.Types.ObjectId,required:!0}});t.Song=n.model("Song",i)},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(7),r=o(0),i=o(2),s=o(1),u=o(6),c=o(3),d=o(5);let a=o(4);t.SongController=class{constructor(e){this.repo=new i.Repository(n.Song),this.youtubeDownload=this.youtubeDownload.bind(this),this.pushToDb=this.pushToDb.bind(this),e.get("/song/ytdl",this.youtubeDownload,this.pushToDb)}youtubeDownload(e,t,o){let r=e.query.q;const i=e.query.origin.toLowerCase()==n.SongType.SPOTIFY?n.SongType.SPOTIFY:n.SongType.LINK;c({url:"https://m.youtube.com/results?client=mv-google&hl=fr&gl=FR&q="+r+"+audio&submit=Rechercher",method:"GET",gzip:!0},(e,n,r)=>{let u=unescape(r).match(/watch\?v=(.*?)+"/)[0].match(/watch\?v=(.*?)\"/)[1],c="http://www.youtube.com/watch?v="+u;a.exec(c,["-x","--audio-format","mp3","-o","./musictmp/"+u+".mp3"],{},function(e,n){return console.log(n),console.log("---------"),e?t.json(s.JsonResponse.error("Can't download youtube video "+u,503)):(t.locals.data=u,t.locals.origin=i,o())})})}pushToDb(e,t,o){this._gridfs=u(r.connection.db,r.mongo);var n=this._gridfs.createWriteStream({filename:t.locals.data});const i="./musictmp/"+t.locals.data+".mp3";d.createReadStream(i).pipe(n);let c=this;d.unlink(i,e=>{n.on("close",function(e){console.log(e),c.repo.create({name:e.filename,artists:["None"],type:t.locals.origin,duration_ms:0,file_id:e._id}),t.json(s.JsonResponse.success(e))})})}}},function(e,t){e.exports=require("bcrypt")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.isUserValid=function(e){let t=e;return void 0!=t.email&&(void 0!=t.spotify_infos||void 0!=t.password)},e.isPlaylistValid=function(e){let t=e;return void 0!=t.title&&void 0!=t.songs&&void 0!=t.user},e.isSongValid=function(e){let t=e;return void 0!=t.name&&void 0!=t.artists&&void 0!=t.type&&void 0!=t.duration_ms&&void 0!=t.file_id}}(t.Checker||(t.Checker={}))},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(0);let r=new n.Schema({country:{type:String,default:"FR",required:!0,index:!0,sparse:!0},spotify_id:{type:String,required:!0,unique:!0,index:!0,sparse:!0},spotify_link:{type:String,required:!0},spotify_api:{type:String,default:""},is_premium:{type:Boolean,required:!0,default:!1},access_token:{type:String,default:"empty"}},{_id:!1}),i=new n.Schema({email:{type:String,required:!0,unique:!0,index:!0},password:{type:String},spotify_infos:r,is_connected:{type:Boolean,required:!0,default:!1},createdAt:{type:Date,required:!0,default:Date.now()}});i.statics.findByMail=function(e,t){return this.findOne({email:e},t)},t.User=n.model("User",i)},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))(function(r,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function u(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){e.done?r(e.value):new o(function(t){t(e.value)}).then(s,u)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=o(11),i=o(2),s=o(10),u=o(1),c=o(9);t.UserController=class{constructor(e){this.model=r.User,this.repo=new i.Repository(this.model),this.register=this.register.bind(this),this.connexion=this.connexion.bind(this),e.post("/user/register",this.register),e.post("/user/connexion",this.connexion)}register(e,t){return n(this,void 0,void 0,function*(){let o=e.body;if(s.Checker.isUserValid(o)){if(void 0!=o.password){let e=c.hashSync(o.password,10);o.password=e;const n=yield this.repo.create(o);return n.err,t.json(n)}{const e=yield this.repo.create(o);return t.json(e)}}return t.json(u.JsonResponse.error("User not valid",400))})}connexion(e,t){let o=e.body;if(void 0==o.email||void 0==o.password)return t.json(u.JsonResponse.error("No email or password",400));this.model.findByMail(o.email,(e,n)=>{if(e||n.is_connected)return t.json(u.JsonResponse.error("Mail not found",400));c.compare(o.password,n.password,(e,o)=>{if(e||!o)return t.json(u.JsonResponse.error("Incorrect password",400));this.model.findByIdAndUpdate(n._id,{is_connected:!0},(e,o)=>e?t.json(u.JsonResponse.error("Something went wrong :(",500)):t.json(u.JsonResponse.success(n)))})})}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.dbHost="localhost",e.dbPort="27017",e.dbName="webify"}(t.DBConfig||(t.DBConfig={}))},function(e,t){e.exports=require("querystring")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(14);!function(e){const t="1ba80100e92d4d49870b7e4fc4931720",o="3da3164990b4482dbdeb3bc941a07466",r="http://localhost:8080/spotify-login";e.spotifyStateKey="spotify_auth_state",e.giveState=function(e){let t="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let n=0;n<e;n++)t+=o.charAt(Math.floor(Math.random()*o.length));return t},e.connexion=function(e,o){return n.stringify({response_type:"code",client_id:t,scope:e,redirect_uri:r,state:o})},e.authentificationOptions=function(e){return{url:"https://accounts.spotify.com/api/token",form:{code:e,redirect_uri:r,grant_type:"authorization_code"},headers:{Authorization:"Basic "+new Buffer(t+":"+o).toString("base64")},json:!0}}}(t.SpotifyConfig||(t.SpotifyConfig={}))},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(15),r=o(3);!function(e){e.spotify_login=function(e,t){let o=n.SpotifyConfig.giveState(16);t.cookie(n.SpotifyConfig.spotifyStateKey,o,{maxAge:9e5,httpOnly:!0});const r=n.SpotifyConfig.connexion("user-read-private user-read-email",o);return t.json(r)},e.spotify_redirect=function(e,t){let o=e.query.code||null,i=e.query.state||null;if(e.cookies&&e.cookies[n.SpotifyConfig.spotifyStateKey],null===i)return t.json({error:"State undefined or different"});{t.clearCookie(n.SpotifyConfig.spotifyStateKey);let e=n.SpotifyConfig.authentificationOptions(o);r.post(e,function(e,o,n){if(e||200!==o.statusCode)return t.json({error:"Unvalidate token"});var i=n.access_token,s=(n.refresh_token,{url:"https://api.spotify.com/v1/me",headers:{Authorization:"Bearer "+i},json:!0});r.get(s,function(e,o,n){return t.json({data:n,access_token:i})})})}}}(t.HelperSpotify||(t.HelperSpotify={}))},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("express")},function(e,t,o){"use strict";(function(n){Object.defineProperty(t,"__esModule",{value:!0});const r=o(19),i=o(18),s=o(17),u=o(16),c=o(13),d=o(0),a=o(12),l=o(8),p=r();p.set("port",process.env.PORT||3e3),p.use(i.json()),p.use(r.urlencoded({extended:!0})),p.use(r.static(n+"/public")).use(s()),p.use((e,t,o)=>{t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Methods","GET,POST,DELETE"),t.header("Access-Control-Allow-Headers","Origin, X-Requested With, Content-Type, Accept"),o()}),d.connect("mongodb://"+c.DBConfig.dbHost+":"+c.DBConfig.dbPort+"/"+c.DBConfig.dbName),p.get("/spotify-login",u.HelperSpotify.spotify_login),p.get("/spotify-redirect",u.HelperSpotify.spotify_redirect);new a.UserController(p),new l.SongController(p);p.listen(p.get("port"),()=>{console.log("App is running at http://localhost:%d",p.get("port")),console.log("Press CTRL-C to stop\n")}),e.exports=p}).call(this,"/")}]);