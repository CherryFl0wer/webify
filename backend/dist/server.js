!function(e){var s={};function t(o){if(s[o])return s[o].exports;var n=s[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,t),n.l=!0,n.exports}t.m=e,t.c=s,t.d=function(e,s,o){t.o(e,s)||Object.defineProperty(e,s,{configurable:!1,enumerable:!0,get:o})},t.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},t.n=function(e){var s=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(s,"a",s),s},t.o=function(e,s){return Object.prototype.hasOwnProperty.call(e,s)},t.p="",t(t.s=29)}([function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),function(e){e.success=function(e){return{type:"success",message:e,code:200}},e.error=function(e,s){return{type:"error",message:e,code:s}}}(s.JsonResponse||(s.JsonResponse={}))},function(e,s){e.exports=require("mongoose")},function(e,s,t){"use strict";var o=this&&this.__awaiter||function(e,s,t,o){return new(t||(t=Promise))(function(n,i){function r(e){try{d(o.next(e))}catch(e){i(e)}}function a(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){e.done?n(e.value):new t(function(s){s(e.value)}).then(r,a)}d((o=o.apply(e,s||[])).next())})};Object.defineProperty(s,"__esModule",{value:!0});const n=t(0);s.Repository=class{constructor(e){this.model=e,this.create=this.create.bind(this),this.updateById=this.updateById.bind(this),this.read=this.read.bind(this),this.remove=this.remove.bind(this)}create(e){return o(this,void 0,void 0,function*(){let s=new(0,this.model)(e);try{let e=yield this.model.create(s);return n.JsonResponse.success(e)}catch(e){return n.JsonResponse.error(e,500)}})}updateById(e,s){return o(this,void 0,void 0,function*(){try{let t=yield this.model.updateOne({_id:e},s);return n.JsonResponse.success(t)}catch(e){return n.JsonResponse.error(e,500)}})}read(e){return o(this,void 0,void 0,function*(){try{let s=yield this.model.findById(e);return n.JsonResponse.success(s)}catch(e){return n.JsonResponse.error(e,500)}})}readBy(e,s){return o(this,void 0,void 0,function*(){try{let e=yield this.model.findOne({field:s});return n.JsonResponse.success(e)}catch(e){return n.JsonResponse.error(e,500)}})}remove(e){return o(this,void 0,void 0,function*(){try{let s=yield this.model.findOneAndRemove({_id:e});return n.JsonResponse.success(s)}catch(e){return n.JsonResponse.error(e,500)}})}}},function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0});const o=t(0);!function(e){e.is_allowed=function(e,s,t){const n=e.session,i=n&&n.user,r=null!=e.body&&null!=e.body.forId;if(!i&&!r)return s.status(500).json(o.JsonResponse.error("User not connected",500));t()}}(s.UserMiddleware||(s.UserMiddleware={}))},function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0});const o=t(1),n=new o.Schema({country:{type:String,default:"FR",required:!0,index:!0,sparse:!0},spotify_id:{type:String,required:!0,unique:!0,index:!0,sparse:!0},spotify_link:{type:String,required:!0},spotify_api:{type:String,default:""},is_premium:{type:Boolean,required:!0,default:!1}},{_id:!1});let i=new o.Schema({email:{type:String,required:!0,unique:!0,index:!0},password:{type:String},spotify_infos:n,song_list:{type:[o.Schema.Types.ObjectId],default:[]},is_connected:{type:Boolean,required:!0,default:!1},createdAt:{type:Date,default:Date.now()},access_token:{type:String}});i.statics.findByMail=function(e,s){return this.findOne({email:e},s)},i.statics.connexion=function(e,s,t){return this.findByIdAndUpdate({_id:e},{is_connected:!0,access_token:s},{new:!0},t)},i.statics.pushSong=function(e,s,t){return this.findByIdAndUpdate({_id:e},{$push:{song_list:s}},{},t)},s.User=o.model("User",i)},function(e,s){e.exports=require("request")},function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0});const o=t(5),n=t(16);!function(e){const s=new n("SongWorker");e.initWorker=function(){s.process(10,(e,s)=>{o("http://localhost:3000/song/ytdl?q="+e.data.keyword+"&origin=spotify",{json:!0,method:"POST",body:{name:e.data.name,artists:e.data.artists,forId:e.data.forId}},(t,o,n)=>t||"error"==n.type?(console.log(t,n),s("Error on job nÂ°"+e.id,null)):s(null,e.data))})},e.enQueue=function(e){s.createJob(e).save()}}(s.SongWorker||(s.SongWorker={}))},function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),function(e){e.isUserValid=function(e){let s=e;return void 0!=s.email&&(void 0!=s.spotify_infos||void 0!=s.password)},e.isPlaylistValid=function(e){return void 0!=e.title},e.isSongValid=function(e){let s=e;return void 0!=s.name&&void 0!=s.artists&&void 0!=s.type&&void 0!=s.duration_ms&&void 0!=s.file_id}}(s.Checker||(s.Checker={}))},function(e,s){e.exports=require("connect-redis")},function(e,s){e.exports=require("express-session")},function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0});const o=t(1);let n=new o.Schema({title:{type:String,required:!0},songs:[{type:o.Schema.Types.ObjectId,ref:"Song"}],user:{type:o.Schema.Types.ObjectId,ref:"User"}});n.statics.findByTitle=function(e,s,t){return this.findOne({$and:[{title:e},{user:o.Types.ObjectId(s)}]},t)},n.statics.findByTitleAndRemove=function(e,s,t){return console.log(e,s),this.findOneAndRemove({$and:[{title:e},{user:o.Types.ObjectId(s)}]},t)},n.statics.addIntoPlaylist=function(e,s,t,o){return this.findOneAndUpdate({$and:[{title:e},{user:s}]},{$push:{songs:t}},{returnNewDocument:!0},o)},n.statics.removeIntoPlaylist=function(e,s,t,n){return this.update({$and:[{title:e},{user:o.Types.ObjectId(s)}]},{$pull:{songs:t}},n)},s.Playlist=o.model("Playlist",n)},function(e,s,t){"use strict";var o=this&&this.__awaiter||function(e,s,t,o){return new(t||(t=Promise))(function(n,i){function r(e){try{d(o.next(e))}catch(e){i(e)}}function a(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){e.done?n(e.value):new t(function(s){s(e.value)}).then(r,a)}d((o=o.apply(e,s||[])).next())})};Object.defineProperty(s,"__esModule",{value:!0});const n=t(2),i=t(7),r=t(0),a=t(3),d=t(1),l=t(10);s.PlaylistController=class{constructor(e){this.model=l.Playlist,this.repo=new n.Repository(this.model),this.create=this.create.bind(this),this.display=this.display.bind(this),this.all=this.all.bind(this),this.delete=this.delete.bind(this),this.removeSong=this.removeSong.bind(this),this.addSong=this.addSong.bind(this),e.post("/playlist/create",a.UserMiddleware.is_allowed,this.create),e.get("/playlist/:title",a.UserMiddleware.is_allowed,this.display),e.get("/playlists",a.UserMiddleware.is_allowed,this.all),e.delete("/playlist/:title",a.UserMiddleware.is_allowed,this.delete),e.post("/playlist/:title/add/:idsong",a.UserMiddleware.is_allowed,this.addSong),e.delete("/playlist/:title/remove/:idsong",a.UserMiddleware.is_allowed,this.removeSong)}create(e,s){return o(this,void 0,void 0,function*(){const t=e.body;if(!i.Checker.isPlaylistValid(t))return s.json(r.JsonResponse.error("Body not valid",500));this.model.findByTitle(t.title,e.session.user._id,(n,i)=>o(this,void 0,void 0,function*(){if(n)return s.status(500).json(r.JsonResponse.error(n,500));if(i)return s.status(500).json(r.JsonResponse.error(t.title+" already exist",500));const o=yield this.repo.create({title:t.title,user:new d.Types.ObjectId(e.session.user._id)});return s.json(o)}))})}display(e,s){const t=e.params.title;this.model.findByTitle(t,e.session.user._id,(e,o)=>e?s.status(500).json(r.JsonResponse.error(e,500)):o?s.json(r.JsonResponse.success(o)):s.status(400).json(r.JsonResponse.error(t+" does not exist",400)))}all(e,s){this.model.find({user:e.session.user._id}).populate("Song").exec((e,t)=>e?s.status(500).json(r.JsonResponse.error(e,500)):s.json(r.JsonResponse.success(t)))}delete(e,s){const t=e.params.title;this.model.findByTitleAndRemove(t,e.session.user._id,(e,t)=>e?s.status(500).json(r.JsonResponse.error(e,500)):s.json(r.JsonResponse.success("Deleted")))}addSong(e,s){const t=e.params.title,o=e.params.idsong;this.model.addIntoPlaylist(t,e.session.user._id,o,(e,t)=>e||!t?s.status(500).json(r.JsonResponse.error(e,500)):s.json(r.JsonResponse.success(t)))}removeSong(e,s){const t=e.params.title,o=e.params.idsong;console.log(t,o),this.model.removeIntoPlaylist(t,e.session.user._id,o,(e,t)=>e||!t?s.status(500).json(r.JsonResponse.error(e,500)):s.json(r.JsonResponse.success("deleted")))}}},function(e,s){e.exports=require("mp3-duration")},function(e,s){e.exports=require("youtube-dl")},function(e,s){e.exports=require("multer")},function(e,s){e.exports=require("fs")},function(e,s){e.exports=require("bee-queue")},function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),function(e){e.arrTimeToMs=function(e){return 3==e.length?(e[0]=60*e[0]*60*1e3,e[1]=60*e[1]*1e3,e[2]=1e3*e[2]):2==e.length?(e[0]=60*e[0]*1e3,e[1]=1e3*e[1]):e[0]=1e3*e[0],e.reduce((e,s)=>e+s,0)}}(s.ArrayHelper||(s.ArrayHelper={}))},function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0});const o=t(1);var n;!function(e){e.SPOTIFY="spotify",e.UPLOAD="upload",e.LINK="link"}(n=s.SongType||(s.SongType={}));let i=new o.Schema({name:{type:String,required:!0},image_cover:{type:String,default:"default.png"},artists:{type:[String],required:!0},type:{type:String,enum:[n.LINK,n.SPOTIFY,n.UPLOAD],required:!0},duration_ms:{type:Number,required:!0,min:0},uri:{type:String,required:!1},file_id:{type:o.Schema.Types.ObjectId,required:!0},added_at:{type:Date,required:!0,default:Date.now()}});i.statics.listSongByObjId=function(e,s){return this.find({_id:{$in:e}},s)},s.Song=o.model("Song",i)},function(e,s,t){"use strict";var o=this&&this.__awaiter||function(e,s,t,o){return new(t||(t=Promise))(function(n,i){function r(e){try{d(o.next(e))}catch(e){i(e)}}function a(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){e.done?n(e.value):new t(function(s){s(e.value)}).then(r,a)}d((o=o.apply(e,s||[])).next())})};Object.defineProperty(s,"__esModule",{value:!0});const n=t(18),i=t(4),r=t(1),a=t(2),d=t(17),l=t(0),u=t(3),c=t(6),p=t(5),f=t(15),h=t(14);let y=t(13),g=t(12);s.SongController=class{constructor(e,s){this.repo=new a.Repository(n.Song),this._gridfs=s;let t=h.diskStorage({destination:function(e,s,t){t(null,"./musictmp/")},filename:function(e,s,t){"audio/mpeg"==s.mimetype||"audio/mp3"==s.mimetype?t(null,"music_"+s.originalname.toLowerCase().replace(/\s+/g,"+")):t(new Error("file is not an mp3 format"),null)}});this._upload=h({storage:t,limits:{fileSize:20971520}}),this.youtubeDownload=this.youtubeDownload.bind(this),this.pushToDb=this.pushToDb.bind(this),this.getListOfSpotifySongs=this.getListOfSpotifySongs.bind(this),this.songUpload=this.songUpload.bind(this),this.loadSong=this.loadSong.bind(this),this.streamSong=this.streamSong.bind(this),this.loadSongs=this.loadSongs.bind(this),this.deletesong=this.deletesong.bind(this),e.post("/song/ytdl",u.UserMiddleware.is_allowed,this.youtubeDownload,this.pushToDb),e.post("/song/spotifytracks",u.UserMiddleware.is_allowed,this.getListOfSpotifySongs),e.post("/song/upload",u.UserMiddleware.is_allowed,this.songUpload,this.pushToDb),e.get("/song/stream/:id",u.UserMiddleware.is_allowed,this.streamSong),e.get("/song/:id",u.UserMiddleware.is_allowed,this.loadSong),e.post("/song/list",u.UserMiddleware.is_allowed,this.loadSongs),e.post("/song/remove/:id",u.UserMiddleware.is_allowed,this.deletesong)}songUpload(e,s,t){this._upload.single("song")(e,s,o=>{if(o)return console.log(o),s.status(500).json(l.JsonResponse.error(o,500));console.log(e.file);const i=e.file,r=e.body;if(!i)return s.status(500).json(l.JsonResponse.error("Undefined file",500));g(i.path,(e,o)=>{s.locals.info={duration:1e3*o,artist:r.artists.split(","),cover:r.cover,name:r.name},s.locals.codeVideo=i.path,s.locals.origin=n.SongType.UPLOAD,t()})})}youtubeDownload(e,s,t){const o=e.query.q,i=e.query.origin.toLowerCase()==n.SongType.SPOTIFY?n.SongType.SPOTIFY:n.SongType.LINK;let r=e.body;if(console.log("Downloading youtube video"),i==n.SongType.SPOTIFY&&null==r.forId)return s.status(500).json(l.JsonResponse.error("Can't download spotify song",500));p({url:"https://m.youtube.com/results?client=mv-google&hl=fr&gl=FR&q="+o+"+audio&submit=Rechercher",method:"GET",gzip:!0},(e,o,a)=>{let u=unescape(a).match(/watch\?v=(.*?)+"/)[0].match(/watch\?v=(.*?)\"/)[1],c="http://www.youtube.com/watch?v="+u;y.getInfo(c,[],(e,o)=>{if(e)throw e;let a=[];o.duration.split(":").forEach(e=>{a.push(parseInt(e))});const p=d.ArrayHelper.arrTimeToMs(a);s.locals.codeVideo=u,s.locals.origin=i,s.locals.info={duration:p,artist:r.artists?r.artists.split(","):o.uploader,name:r.name?r.name:o.title,cover:r.cover?r.cover:"https://i.ytimg.com/vi/"+u+"/maxresdefault.jpg"},i==n.SongType.SPOTIFY&&(s.locals.forId=r.forId),console.log("Downloading -> ",u," waiting..."),y.exec(c,["-x","--audio-format","mp3","-o","./musictmp/music_"+u+".mp3"],{},(e,o)=>e?s.status(500).json(l.JsonResponse.error("Can't download youtube video "+u,500)):t())})})}pushToDb(e,s,t){console.log("Done finished downloading ",s.locals.info.name);let r=this._gridfs.openUploadStream(s.locals.codeVideo,{metadata:s.locals.info});const a=s.locals.origin==n.SongType.UPLOAD?s.locals.codeVideo:"./musictmp/music_"+s.locals.codeVideo+".mp3";f.createReadStream(a).pipe(r);let d=this;f.unlink(a,t=>{if(t)return s.status(500).json(l.JsonResponse.error(t,500));r.once("finish",function(){return o(this,void 0,void 0,function*(){let t=s.locals.info.artist instanceof Array?s.locals.info.artist:[s.locals.info.artist],o=yield d.repo.create({name:s.locals.info.name,image_cover:s.locals.info.cover,artists:t,type:s.locals.origin,duration_ms:s.locals.info.duration,file_id:r.id}),a=s.locals.origin!=n.SongType.SPOTIFY?e.session.user._id:s.locals.forId;i.User.pushSong(a,o.message._id,(e,t)=>e?s.status(500).json(l.JsonResponse.error(e,500)):s.json(o))})})})}getListOfSpotifySongs(e,s,t){let o=e.body.at,n=0,i=0;p("https://api.spotify.com/v1/me/tracks?limit=50&offset="+n,{json:!0,withCredentials:!0,headers:{Authorization:"Bearer "+o}},(t,o,r)=>t||r.error?s.status(403).json(l.JsonResponse.error("Access token expired",403)):(n+=50,i=r.total,r.items.forEach(s=>{const t=s.track.artists;let o=s.track.name;t.length>0&&(o+=" "+t[0].name),o=o.replace(/\s+/g,"+");const n=t.map(e=>e.name).reduce((e,s)=>e+s+",","");console.log("Enqueuing spotify:",s.track.id," - ",o),c.SongWorker.enQueue({videoId:s.track.id,artists:n.substring(0,n.length-1),name:s.track.name,keyword:o,forId:e.session.user._id})}),s.json(l.JsonResponse.success("Downloading your last 50 songs"))))}loadSong(e,s){const t=e.params.id;n.Song.findById(t,(e,t)=>s.json(l.JsonResponse.success(t)))}loadSongs(e,s){const t=e.body;n.Song.listSongByObjId(t.data,(e,t)=>s.json(l.JsonResponse.success(t)))}streamSong(e,s){const t=e.params.id;s.set("content-type","audio/mp3"),s.set("accept-ranges","bytes");try{var o=new r.mongo.ObjectId(t)}catch(e){return s.status(400).json(l.JsonResponse.error("Incorrect ID",400))}let n=this._gridfs.openDownloadStream(o);n.on("data",e=>{s.write(e)}),n.on("error",()=>{s.sendStatus(404)}),n.on("end",()=>{s.end()})}deletesong(e,s){let t=e.params.id,o=this;n.Song.findByIdAndRemove(t,(t,n)=>{if(t||!n)return s.status(500).json(l.JsonResponse.error(t,500));i.User.update({_id:r.Types.ObjectId(e.session.user._id)},{$pull:{song_list:r.Types.ObjectId(n._id)}},(e,t)=>{if(e)return console.log(e),s.status(500).json(l.JsonResponse.error(e,500));o._gridfs.delete(n.file_id,e=>e?(console.log(e),s.status(500).json(l.JsonResponse.error(e,500))):s.json(l.JsonResponse.success("Song deleted")))})})}}},function(e,s){e.exports=require("bcrypt")},function(e,s,t){"use strict";var o=this&&this.__awaiter||function(e,s,t,o){return new(t||(t=Promise))(function(n,i){function r(e){try{d(o.next(e))}catch(e){i(e)}}function a(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){e.done?n(e.value):new t(function(s){s(e.value)}).then(r,a)}d((o=o.apply(e,s||[])).next())})};Object.defineProperty(s,"__esModule",{value:!0});const n=t(4),i=t(2),r=t(7),a=t(0),d=t(3),l=t(20);s.UserController=class{constructor(e){this.repo=new i.Repository(n.User),this.register=this.register.bind(this),this.connexion=this.connexion.bind(this),this.logout=this.logout.bind(this),this.songlist=this.songlist.bind(this),this.getCurrentSession=this.getCurrentSession.bind(this),e.post("/user/register",this.register),e.post("/user/connexion",this.connexion),e.post("/user/logout",d.UserMiddleware.is_allowed,this.logout),e.get("/user/session",d.UserMiddleware.is_allowed,this.getCurrentSession),e.get("/user/spotify_songlist",d.UserMiddleware.is_allowed,this.songlist)}register(e,s){return o(this,void 0,void 0,function*(){let t=e.body;if(r.Checker.isUserValid(t)){if(void 0!=t.password){let e=l.hashSync(t.password,10);t.password=e;const o=yield this.repo.create(t);return s.json(o)}{const e=yield this.repo.create(t);return s.json(e)}}return s.json(a.JsonResponse.error("User not valid",400))})}songlist(e,s){let t=e.session.user;n.User.findById(t._id,(e,t)=>e?s.status(500).json(a.JsonResponse.error("Can't reach user",500)):s.json(a.JsonResponse.success(t.song_list)))}connexion(e,s){let t=e.body;if(void 0==t.email||void 0==t.password)return s.status(500).json(a.JsonResponse.error("No email or password",400));n.User.findByMail(t.email,(o,i)=>o||!i?s.status(400).json(a.JsonResponse.error("Mail not found",400)):i.is_connected?s.status(500).json(a.JsonResponse.error("Already connected",500)):void l.compare(t.password,i.password,(t,o)=>{if(t||!o)return s.status(400).json(a.JsonResponse.error("Incorrect password",400));n.User.findByIdAndUpdate(i._id,{is_connected:!0},(t,o)=>t?s.status(500).json(a.JsonResponse.error("Something went wrong :(",500)):(i.is_connected=!0,e.session.user=i,s.json(a.JsonResponse.success(i))))}))}getCurrentSession(e,s){return e.session.user?s.json(a.JsonResponse.success(e.session.user)):s.status(400)}logout(e,s){n.User.findByIdAndUpdate(e.session.user._id,{is_connected:!1},(t,o)=>t?s.status(500).json(a.JsonResponse.error(t,500)):(e.session.destroy(),s.json(a.JsonResponse.success("Successfull disconnect"))))}}},function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),function(e){e.dbHost="localhost",e.dbPort="27017",e.dbName="webify"}(s.DBConfig||(s.DBConfig={}))},function(e,s){e.exports=require("querystring")},function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0});const o=t(23);!function(e){const s="1ba80100e92d4d49870b7e4fc4931720",t="3da3164990b4482dbdeb3bc941a07466",n="http://localhost:8080/spotify-login";e.spotifyStateKey="spotify_auth_state",e.giveState=function(e){let s="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<e;o++)s+=t.charAt(Math.floor(Math.random()*t.length));return s},e.connexion=function(e,t){return o.stringify({response_type:"code",client_id:s,scope:e,redirect_uri:n,state:t})},e.authentificationOptions=function(e){return{url:"https://accounts.spotify.com/api/token",form:{code:e,redirect_uri:n,grant_type:"authorization_code"},headers:{Authorization:"Basic "+new Buffer(s+":"+t).toString("base64")},json:!0}}}(s.SpotifyConfig||(s.SpotifyConfig={}))},function(e,s,t){"use strict";var o=this&&this.__awaiter||function(e,s,t,o){return new(t||(t=Promise))(function(n,i){function r(e){try{d(o.next(e))}catch(e){i(e)}}function a(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){e.done?n(e.value):new t(function(s){s(e.value)}).then(r,a)}d((o=o.apply(e,s||[])).next())})};Object.defineProperty(s,"__esModule",{value:!0});const n=t(24),i=t(5),r=t(2),a=t(4),d=t(0);!function(e){e.spotify_login=function(e,s){let t=n.SpotifyConfig.giveState(16);s.cookie(n.SpotifyConfig.spotifyStateKey,t,{maxAge:9e5,httpOnly:!0});const o=n.SpotifyConfig.connexion("user-read-private user-read-email user-library-read",t);return s.json(o)},e.spotify_redirect=function(e,s){let t=e.query.code||null,l=e.query.state||null;e.cookies&&e.cookies[n.SpotifyConfig.spotifyStateKey];const u=new r.Repository(a.User);if(null===l)return s.json({error:"State undefined or different"});{s.clearCookie(n.SpotifyConfig.spotifyStateKey);let r=n.SpotifyConfig.authentificationOptions(t);i.post(r,function(t,n,r){if(t||200!==n.statusCode)return s.json({error:"Unvalidate token"});var l=r.access_token,c=(r.refresh_token,{url:"https://api.spotify.com/v1/me",headers:{Authorization:"Bearer "+l},json:!0});i.get(c,function(t,n,i){a.User.findByMail(i.email,(t,n)=>o(this,void 0,void 0,function*(){if(t)return s.json(d.JsonResponse.error(t,500));if(n)a.User.connexion(n._id,l,(t,o)=>(e.session.user=o,s.json(d.JsonResponse.success({user:o}))));else{let t=yield u.create({email:i.email,is_connected:!0,access_token:l,spotify_infos:{country:i.country,spotify_id:i.id,is_premium:"premium"==i.product,spotify_link:i.href,spotify_api:i.href}});if("error"==t.type)return s.status(500).json(d.JsonResponse.error("Can't create spotify user",500));e.session.user=t.message,e.session.save(e=>e?s.status(500).json(d.JsonResponse.error("Can't save session",500)):s.json(t))}}))})})}}}(s.HelperSpotify||(s.HelperSpotify={}))},function(e,s){e.exports=require("cookie-parser")},function(e,s){e.exports=require("body-parser")},function(e,s){e.exports=require("express")},function(e,s,t){"use strict";(function(o){Object.defineProperty(s,"__esModule",{value:!0});const n=t(28),i=t(27),r=t(26),a=t(1),d=t(25),l=t(22),u=t(21),c=t(19),p=t(11),f=t(6),h=n(),y=t(9);t(8)(y);h.use(y({secret:"IOuL85f4a10lNbs",resave:!0,saveUninitialized:!0,maxAge:864e5})),h.set("port",process.env.PORT||3e3),h.set("portSocket",process.env.PORTSOCKET||4808),h.set("trust proxy",1),h.use(i.json()),h.use(n.urlencoded({extended:!0})),h.use(n.static(o+"/public")).use(r()),h.use((e,s,t)=>{s.header("Access-Control-Allow-Origin","http://localhost:8080"),s.header("Access-Control-Allow-Credentials","true"),s.header("Access-Control-Allow-Methods","GET,POST,DELETE"),s.header("Access-Control-Allow-Headers","Origin, X-Requested With, Content-Type, Accept"),t()}),a.connect("mongodb://"+l.DBConfig.dbHost+":"+l.DBConfig.dbPort+"/"+l.DBConfig.dbName),a.connection.once("open",()=>{let e=new a.mongo.GridFSBucket(a.connection.db);new u.UserController(h),new c.SongController(h,e),new p.PlaylistController(h);h.get("/spotify-login",d.HelperSpotify.spotify_login),h.get("/spotify-redirect",d.HelperSpotify.spotify_redirect),h.listen(h.get("port"),()=>{console.log("App is running at http://localhost:%d",h.get("port")),console.log("Press CTRL-C to stop\n"),f.SongWorker.initWorker()})}),e.exports=h}).call(this,"/")}]);