!function(e){var t={};function o(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,o),i.l=!0,i.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},o.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=28)}([function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.success=function(e){return{type:"success",message:e,code:200}},e.error=function(e,t){return{type:"error",message:e,code:t}}}(t.JsonResponse||(t.JsonResponse={}))},function(e,t){e.exports=require("mongoose")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(1),i=new n.Schema({country:{type:String,default:"FR",required:!0,index:!0,sparse:!0},spotify_id:{type:String,required:!0,unique:!0,index:!0,sparse:!0},spotify_link:{type:String,required:!0},spotify_api:{type:String,default:""},is_premium:{type:Boolean,required:!0,default:!1}},{_id:!1});let s=new n.Schema({email:{type:String,required:!0,unique:!0,index:!0},password:{type:String},spotify_infos:i,song_list:{type:[n.Schema.Types.ObjectId],default:[]},is_connected:{type:Boolean,required:!0,default:!1},createdAt:{type:Date,default:Date.now()},access_token:{type:String}});s.statics.findByMail=function(e,t){return this.findOne({email:e},t)},s.statics.connexion=function(e,t,o){return this.findByIdAndUpdate({_id:e},{is_connected:!0,access_token:t},{new:!0},o)},s.statics.pushSong=function(e,t,o){return this.findByIdAndUpdate({_id:e},{$push:{song_list:t}},{},o)},t.User=n.model("User",s)},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))(function(i,s){function r(e){try{u(n.next(e))}catch(e){s(e)}}function c(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){e.done?i(e.value):new o(function(t){t(e.value)}).then(r,c)}u((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const i=o(0);t.Repository=class{constructor(e){this.model=e,this.create=this.create.bind(this),this.updateById=this.updateById.bind(this),this.read=this.read.bind(this),this.remove=this.remove.bind(this)}create(e){return n(this,void 0,void 0,function*(){let t=new(0,this.model)(e);try{let e=yield this.model.create(t);return i.JsonResponse.success(e)}catch(e){return i.JsonResponse.error(e,500)}})}updateById(e,t){return n(this,void 0,void 0,function*(){try{let o=yield this.model.updateOne({_id:e},t);return i.JsonResponse.success(o)}catch(e){return i.JsonResponse.error(e,500)}})}read(e){return n(this,void 0,void 0,function*(){try{let t=yield this.model.findById(e);return i.JsonResponse.success(t)}catch(e){return i.JsonResponse.error(e,500)}})}remove(e){return n(this,void 0,void 0,function*(){try{let t=yield this.model.findOneAndRemove({_id:e});return i.JsonResponse.success(t)}catch(e){return i.JsonResponse.error(e,500)}})}}},function(e,t){e.exports=require("request")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(4),i=o(13);!function(e){const t=new i("SongWorker");e.initWorker=function(){t.process(10,(e,t)=>{console.log(`[${e.id}] Processing download on ${e.data.videoId}`),console.log("Requesting http://localhost:3000/song/ytdl?q="+e.data.keyword+"&origin=spotify"),n("http://localhost:3000/song/ytdl?q="+e.data.keyword+"&origin=spotify",{json:!0,body:{name:e.data.name,artists:e.data.artists}},(o,n,i)=>o||"error"==i.type?t("Error on job nÂ°"+e.id,null):t(null,e.data))})},e.enQueue=function(e){t.createJob(e).save()}}(t.SongWorker||(t.SongWorker={}))},function(e,t){e.exports=require("connect-redis")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("mp3-duration")},function(e,t){e.exports=require("youtube-dl")},function(e,t){e.exports=require("multer")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("gridfs-stream")},function(e,t){e.exports=require("bee-queue")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(0);!function(e){e.is_allowed=function(e,t,o){const i=e.session;i&&i.user&&i.user.is_connected?o():t.json(n.JsonResponse.error("User not connected",400))}}(t.UserMiddleware||(t.UserMiddleware={}))},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.arrTimeToMs=function(e){return 3==e.length?(e[0]=60*e[0]*60*1e3,e[1]=60*e[1]*1e3,e[2]=1e3*e[2]):2==e.length?(e[0]=60*e[0]*1e3,e[1]=1e3*e[1]):e[0]=1e3*e[0],e.reduce((e,t)=>e+t,0)}}(t.ArrayHelper||(t.ArrayHelper={}))},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(1);var i;!function(e){e.SPOTIFY="spotify",e.UPLOAD="upload",e.LINK="link"}(i=t.SongType||(t.SongType={}));let s=new n.Schema({name:{type:String,required:!0},image_cover:{type:String,default:"default.png"},artists:{type:[String],required:!0},type:{type:String,enum:[i.LINK,i.SPOTIFY,i.UPLOAD],required:!0},duration_ms:{type:Number,required:!0,min:0},uri:{type:String,required:!1},file_id:{type:n.Schema.Types.ObjectId,required:!0}});t.Song=n.model("Song",s)},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))(function(i,s){function r(e){try{u(n.next(e))}catch(e){s(e)}}function c(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){e.done?i(e.value):new o(function(t){t(e.value)}).then(r,c)}u((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const i=o(16),s=o(2),r=o(1),c=o(3),u=o(15),a=o(0),l=o(14),d=o(5),p=o(12),f=o(4),y=o(11),h=o(10);let g=o(9),m=o(8);t.SongController=class{constructor(e){this.repo=new c.Repository(i.Song);let t=h.diskStorage({destination:function(e,t,o){o(null,"./musictmp/")},filename:function(e,t,o){"audio/mpeg"!=t.mimetype&&o(new Error("file is not an mp3 format"),null),o(null,"music_"+t.originalname.toLowerCase().replace(/\s+/g,"+"))}});this._upload=h({storage:t}),this.youtubeDownload=this.youtubeDownload.bind(this),this.pushToDb=this.pushToDb.bind(this),this.getListOfSpotifySongs=this.getListOfSpotifySongs.bind(this),this.songUpload=this.songUpload.bind(this),e.post("/song/ytdl",l.UserMiddleware.is_allowed,this.youtubeDownload,this.pushToDb),e.post("/song/spotifytracks",l.UserMiddleware.is_allowed,this.getListOfSpotifySongs),e.post("/song/upload",l.UserMiddleware.is_allowed,this._upload.single("song"),this.songUpload,this.pushToDb)}songUpload(e,t,o){const n=e.file;m(n.path,(e,s)=>{t.locals.info={tags:[],duration:1e3*s,artist:"",cover:"",name:n.originalname},t.locals.codeVideo=n.path,t.locals.origin=i.SongType.UPLOAD,console.log(t.locals),o()})}youtubeDownload(e,t,o){let n=e.query.q,s=e.query.origin,r=e.body;const c=s.toLowerCase()==i.SongType.SPOTIFY?i.SongType.SPOTIFY:i.SongType.LINK;f({url:"https://m.youtube.com/results?client=mv-google&hl=fr&gl=FR&q="+n+"+audio&submit=Rechercher",method:"GET",gzip:!0},(e,n,s)=>{let l=unescape(s).match(/watch\?v=(.*?)+"/)[0].match(/watch\?v=(.*?)\"/)[1],d="http://www.youtube.com/watch?v="+l;g.getInfo(d,[],(e,n)=>{if(e)throw e;let s=[];n.duration.split(":").forEach(e=>{s.push(parseInt(e))});const p=u.ArrayHelper.arrTimeToMs(s);t.locals.codeVideo=l,t.locals.origin=c,t.locals.info={tags:n.tags,duration:p,artist:n.uploader,name:n.title,cover:"https://i.ytimg.com/vi/"+l+"/maxresdefault.jpg"},console.log("Downloading -> ",l," waiting..."),g.exec(d,["-x","--audio-format","mp3","-o","./musictmp/music_"+l+".mp3"],{},(e,n)=>e?t.json(a.JsonResponse.error("Can't download youtube video "+l,503)):(c==i.SongType.SPOTIFY&&(t.locals.info.artist=r.artists.map(e=>e.name),t.locals.info.name=r.name),o()))})})}pushToDb(e,t,o){console.log("Done finished downloading ",t.locals.info.name),this._gridfs=p(r.connection.db,r.mongo);let c=this._gridfs.createWriteStream({filename:t.locals.codeVideo,metadata:t.locals.info});const u=t.locals.origin==i.SongType.UPLOAD?t.locals.codeVideo:"./musictmp/music_"+t.locals.codeVideo+".mp3";y.createReadStream(u).pipe(c);let l=this;console.log(u),console.log(t.locals),y.unlink(u,o=>{if(o)return t.json(a.JsonResponse.error(o,500));c.on("close",function(o){return n(this,void 0,void 0,function*(){let n=t.locals.info.artist instanceof Array?t.locals.info.artist:[t.locals.info.artist],i=t.locals.info.name,r=yield l.repo.create({name:i,image_cover:t.locals.info.cover,artists:n,type:t.locals.origin,duration_ms:t.locals.info.duration,file_id:o._id});s.User.pushSong(e.session.user._id,r.message._id,(e,o)=>e?t.json(a.JsonResponse.error(e,500)):t.json(r))})})})}getListOfSpotifySongs(e,t,o){let n=e.body.at,i=0;f("https://api.spotify.com/v1/me/tracks?limit=50&offset=0",{json:!0,headers:{Authorization:"Bearer "+n}},(e,o,n)=>e||n.error?t.json(a.JsonResponse.error("Access token expired",403)):(i=n.total,n.items.forEach(e=>{const t=e.track.artists;let o=e.track.name;t.length>0&&(o+=" "+t[0].name),o=o.replace(/\s+/g,"+"),console.log("Enqueuing spotify:",e.track.id," - ",o),d.SongWorker.enQueue({videoId:e.track.id,keyword:o,artists:t,name:e.track.name})}),t.json(n)))}}},function(e,t){e.exports=require("bcrypt")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.isUserValid=function(e){let t=e;return void 0!=t.email&&(void 0!=t.spotify_infos||void 0!=t.password)},e.isPlaylistValid=function(e){let t=e;return void 0!=t.title&&void 0!=t.songs&&void 0!=t.user},e.isSongValid=function(e){let t=e;return void 0!=t.name&&void 0!=t.artists&&void 0!=t.type&&void 0!=t.duration_ms&&void 0!=t.file_id}}(t.Checker||(t.Checker={}))},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))(function(i,s){function r(e){try{u(n.next(e))}catch(e){s(e)}}function c(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){e.done?i(e.value):new o(function(t){t(e.value)}).then(r,c)}u((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const i=o(2),s=o(3),r=o(19),c=o(0),u=o(18);t.UserController=class{constructor(e){this.model=i.User,this.repo=new s.Repository(this.model),this.register=this.register.bind(this),this.connexion=this.connexion.bind(this),e.post("/user/register",this.register),e.post("/user/connexion",this.connexion)}register(e,t){return n(this,void 0,void 0,function*(){let o=e.body;if(r.Checker.isUserValid(o)){if(void 0!=o.password){let e=u.hashSync(o.password,10);o.password=e;const n=yield this.repo.create(o);return t.json(n)}{const e=yield this.repo.create(o);return t.json(e)}}return t.json(c.JsonResponse.error("User not valid",400))})}connexion(e,t){let o=e.body;if(void 0==o.email||void 0==o.password)return t.json(c.JsonResponse.error("No email or password",400));this.model.findByMail(o.email,(n,i)=>{if(n||i.is_connected)return t.json(c.JsonResponse.error("Mail not found",400));u.compare(o.password,i.password,(o,n)=>{if(o||!n)return t.json(c.JsonResponse.error("Incorrect password",400));this.model.findByIdAndUpdate(i._id,{is_connected:!0},(o,n)=>o?t.json(c.JsonResponse.error("Something went wrong :(",500)):(i.is_connected=!0,e.session.user=i,t.json(c.JsonResponse.success(i))))})})}logout(e,t){const o=e.session;t.json(o)}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.dbHost="localhost",e.dbPort="27017",e.dbName="webify"}(t.DBConfig||(t.DBConfig={}))},function(e,t){e.exports=require("querystring")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(22);!function(e){const t="1ba80100e92d4d49870b7e4fc4931720",o="3da3164990b4482dbdeb3bc941a07466",i="http://localhost:8080/spotify-login";e.spotifyStateKey="spotify_auth_state",e.giveState=function(e){let t="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let n=0;n<e;n++)t+=o.charAt(Math.floor(Math.random()*o.length));return t},e.connexion=function(e,o){return n.stringify({response_type:"code",client_id:t,scope:e,redirect_uri:i,state:o})},e.authentificationOptions=function(e){return{url:"https://accounts.spotify.com/api/token",form:{code:e,redirect_uri:i,grant_type:"authorization_code"},headers:{Authorization:"Basic "+new Buffer(t+":"+o).toString("base64")},json:!0}}}(t.SpotifyConfig||(t.SpotifyConfig={}))},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))(function(i,s){function r(e){try{u(n.next(e))}catch(e){s(e)}}function c(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){e.done?i(e.value):new o(function(t){t(e.value)}).then(r,c)}u((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const i=o(23),s=o(4),r=o(3),c=o(2),u=o(0);!function(e){e.spotify_login=function(e,t){let o=i.SpotifyConfig.giveState(16);t.cookie(i.SpotifyConfig.spotifyStateKey,o,{maxAge:9e5,httpOnly:!0});const n=i.SpotifyConfig.connexion("user-read-private user-read-email user-library-read",o);return t.json(n)},e.spotify_redirect=function(e,t){let o=e.query.code||null,a=e.query.state||null;e.cookies&&e.cookies[i.SpotifyConfig.spotifyStateKey];const l=new r.Repository(c.User);if(null===a)return t.json({error:"State undefined or different"});{t.clearCookie(i.SpotifyConfig.spotifyStateKey);let r=i.SpotifyConfig.authentificationOptions(o);s.post(r,function(o,i,r){if(o||200!==i.statusCode)return t.json({error:"Unvalidate token"});var a=r.access_token,d=(r.refresh_token,{url:"https://api.spotify.com/v1/me",headers:{Authorization:"Bearer "+a},json:!0});s.get(d,function(o,i,s){c.User.findByMail(s.email,(o,i)=>n(this,void 0,void 0,function*(){if(o)return t.json(u.JsonResponse.error(o,500));if(console.log(a),!i){let o=yield l.create({email:s.email,is_connected:!0,access_token:a,spotify_infos:{country:s.country,spotify_id:s.id,is_premium:"premium"==s.product,spotify_link:s.href,spotify_api:s.href}});return"error"!=o.type&&(e.session.user=o.message),t.json(o)}c.User.connexion(i._id,a,(o,n)=>(e.session.user=n,t.json(u.JsonResponse.success({user:n}))))}))})})}}}(t.HelperSpotify||(t.HelperSpotify={}))},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("express")},function(e,t,o){"use strict";(function(n){Object.defineProperty(t,"__esModule",{value:!0});const i=o(27),s=o(26),r=o(25),c=o(1),u=o(24),a=o(21),l=o(20),d=o(17),p=o(5),f=i(),y=o(7),h=o(6)(y);f.use(y({store:new h,secret:"IOuL85f4a10lNbs",resave:!1,saveUninitialized:!0})),f.set("port",process.env.PORT||3e3),f.set("trust proxy",1),f.use(s.json()),f.use(i.urlencoded({extended:!0})),f.use(i.static(n+"/public")).use(r()),f.use((e,t,o)=>{t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Methods","GET,POST,DELETE"),t.header("Access-Control-Allow-Headers","Origin, X-Requested With, Content-Type, Accept"),o()}),c.connect("mongodb://"+a.DBConfig.dbHost+":"+a.DBConfig.dbPort+"/"+a.DBConfig.dbName),f.get("/spotify-login",u.HelperSpotify.spotify_login),f.get("/spotify-redirect",u.HelperSpotify.spotify_redirect);new l.UserController(f),new d.SongController(f);f.listen(f.get("port"),()=>{console.log("App is running at http://localhost:%d",f.get("port")),console.log("Press CTRL-C to stop\n"),p.SongWorker.initWorker()}),e.exports=f}).call(this,"/")}]);