!function(e){var t={};function s(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=t,s.d=function(e,t,o){s.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},s.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=29)}([function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.success=function(e){return{type:"success",message:e,code:200}},e.error=function(e,t){return{type:"error",message:e,code:t}}}(t.JsonResponse||(t.JsonResponse={}))},function(e,t){e.exports=require("mongoose")},function(e,t,s){"use strict";var o=this&&this.__awaiter||function(e,t,s,o){return new(s||(s=Promise))(function(n,i){function r(e){try{d(o.next(e))}catch(e){i(e)}}function a(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){e.done?n(e.value):new s(function(t){t(e.value)}).then(r,a)}d((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const n=s(0);t.Repository=class{constructor(e){this.model=e,this.create=this.create.bind(this),this.updateById=this.updateById.bind(this),this.read=this.read.bind(this),this.remove=this.remove.bind(this)}create(e){return o(this,void 0,void 0,function*(){let t=new(0,this.model)(e);try{let e=yield this.model.create(t);return n.JsonResponse.success(e)}catch(e){return n.JsonResponse.error(e,500)}})}updateById(e,t){return o(this,void 0,void 0,function*(){try{let s=yield this.model.updateOne({_id:e},t);return n.JsonResponse.success(s)}catch(e){return n.JsonResponse.error(e,500)}})}read(e){return o(this,void 0,void 0,function*(){try{let t=yield this.model.findById(e);return n.JsonResponse.success(t)}catch(e){return n.JsonResponse.error(e,500)}})}readBy(e,t){return o(this,void 0,void 0,function*(){try{let e=yield this.model.findOne({field:t});return n.JsonResponse.success(e)}catch(e){return n.JsonResponse.error(e,500)}})}remove(e){return o(this,void 0,void 0,function*(){try{let t=yield this.model.findOneAndRemove({_id:e});return n.JsonResponse.success(t)}catch(e){return n.JsonResponse.error(e,500)}})}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=s(0);!function(e){e.is_allowed=function(e,t,s){const n=e.session,i=n&&n.user,r=null!=e.body&&null!=e.body.forId;if(!i&&!r)return t.status(500).json(o.JsonResponse.error("User not connected",500));s()}}(t.UserMiddleware||(t.UserMiddleware={}))},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=s(1),n=new o.Schema({country:{type:String,default:"FR",required:!0,index:!0,sparse:!0},spotify_id:{type:String,required:!0,unique:!0,index:!0,sparse:!0},spotify_link:{type:String,required:!0},spotify_api:{type:String,default:""},is_premium:{type:Boolean,required:!0,default:!1}},{_id:!1});let i=new o.Schema({email:{type:String,required:!0,unique:!0,index:!0},password:{type:String},spotify_infos:n,song_list:{type:[o.Schema.Types.ObjectId],default:[]},is_connected:{type:Boolean,required:!0,default:!1},createdAt:{type:Date,default:Date.now()},access_token:{type:String}});i.statics.findByMail=function(e,t){return this.findOne({email:e},t)},i.statics.connexion=function(e,t,s){return this.findByIdAndUpdate({_id:e},{is_connected:!0,access_token:t},{new:!0},s)},i.statics.pushSong=function(e,t,s){return this.findByIdAndUpdate({_id:e},{$push:{song_list:t}},{},s)},t.User=o.model("User",i)},function(e,t){e.exports=require("request")},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=s(5),n=s(16);!function(e){const t=new n("SongWorker");e.initWorker=function(){t.process(10,(e,t)=>{o("http://localhost:3000/song/ytdl?q="+e.data.keyword+"&origin=spotify",{json:!0,method:"POST",body:{name:e.data.name,artists:e.data.artists,forId:e.data.forId}},(s,o,n)=>s||"error"==n.type?(console.log(s,n),t("Error on job nÂ°"+e.id,null)):t(null,e.data))})},e.enQueue=function(e){t.createJob(e).save()}}(t.SongWorker||(t.SongWorker={}))},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.isUserValid=function(e){let t=e;return void 0!=t.email&&(void 0!=t.spotify_infos||void 0!=t.password)},e.isPlaylistValid=function(e){return void 0!=e.title},e.isSongValid=function(e){let t=e;return void 0!=t.name&&void 0!=t.artists&&void 0!=t.type&&void 0!=t.duration_ms&&void 0!=t.file_id}}(t.Checker||(t.Checker={}))},function(e,t){e.exports=require("connect-redis")},function(e,t){e.exports=require("express-session")},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=s(1);let n=new o.Schema({title:{type:String,required:!0},songs:[{type:o.Schema.Types.ObjectId,ref:"Song"}],user:{type:o.Schema.Types.ObjectId,ref:"User"}});n.statics.findByTitle=function(e,t,s){return this.findOne({$and:[{title:e},{user:o.Types.ObjectId(t)}]},s)},n.statics.findByTitleAndRemove=function(e,t,s){return console.log(e,t),this.findOneAndRemove({$and:[{title:e},{user:o.Types.ObjectId(t)}]},s)},n.statics.addIntoPlaylist=function(e,t,s,o){return this.findOneAndUpdate({$and:[{title:e},{user:t}]},{$push:{songs:s}},{returnNewDocument:!0},o)},t.Playlist=o.model("Playlist",n)},function(e,t,s){"use strict";var o=this&&this.__awaiter||function(e,t,s,o){return new(s||(s=Promise))(function(n,i){function r(e){try{d(o.next(e))}catch(e){i(e)}}function a(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){e.done?n(e.value):new s(function(t){t(e.value)}).then(r,a)}d((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const n=s(2),i=s(7),r=s(0),a=s(3),d=s(1),u=s(10);t.PlaylistController=class{constructor(e){this.model=u.Playlist,this.repo=new n.Repository(this.model),this.create=this.create.bind(this),this.display=this.display.bind(this),this.all=this.all.bind(this),this.delete=this.delete.bind(this),this.addSong=this.addSong.bind(this),e.post("/playlist/create",a.UserMiddleware.is_allowed,this.create),e.get("/playlist/:title",a.UserMiddleware.is_allowed,this.display),e.get("/playlists",a.UserMiddleware.is_allowed,this.all),e.delete("/playlist/:title",a.UserMiddleware.is_allowed,this.delete),e.post("/playlist/:title/add/:idsong",a.UserMiddleware.is_allowed,this.addSong)}create(e,t){return o(this,void 0,void 0,function*(){const s=e.body;if(!i.Checker.isPlaylistValid(s))return t.json(r.JsonResponse.error("Body not valid",500));this.model.findByTitle(s.title,e.session.user._id,(n,i)=>o(this,void 0,void 0,function*(){if(n)return t.status(500).json(r.JsonResponse.error(n,500));if(i)return t.status(500).json(r.JsonResponse.error(s.title+" already exist",500));const o=yield this.repo.create({title:s.title,user:new d.Types.ObjectId(e.session.user._id)});return t.json(o)}))})}display(e,t){const s=e.params.title;this.model.findByTitle(s,e.session.user._id,(e,o)=>e?t.status(500).json(r.JsonResponse.error(e,500)):o?t.json(r.JsonResponse.success(o)):t.status(400).json(r.JsonResponse.error(s+" does not exist",400)))}all(e,t){this.model.find({user:e.session.user._id}).populate("Song").exec((e,s)=>e?t.status(500).json(r.JsonResponse.error(e,500)):t.json(r.JsonResponse.success(s)))}delete(e,t){const s=e.params.title;this.model.findByTitleAndRemove(s,e.session.user._id,(e,s)=>e?t.status(500).json(r.JsonResponse.error(e,500)):t.json(r.JsonResponse.success("Deleted")))}addSong(e,t){const s=e.params.title,o=e.params.idsong;this.model.addIntoPlaylist(s,e.session.user._id,o,(e,s)=>e||!s?t.status(500).json(r.JsonResponse.error(e,500)):t.json(r.JsonResponse.success(s)))}}},function(e,t){e.exports=require("mp3-duration")},function(e,t){e.exports=require("youtube-dl")},function(e,t){e.exports=require("multer")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("bee-queue")},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.arrTimeToMs=function(e){return 3==e.length?(e[0]=60*e[0]*60*1e3,e[1]=60*e[1]*1e3,e[2]=1e3*e[2]):2==e.length?(e[0]=60*e[0]*1e3,e[1]=1e3*e[1]):e[0]=1e3*e[0],e.reduce((e,t)=>e+t,0)}}(t.ArrayHelper||(t.ArrayHelper={}))},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=s(1);var n;!function(e){e.SPOTIFY="spotify",e.UPLOAD="upload",e.LINK="link"}(n=t.SongType||(t.SongType={}));let i=new o.Schema({name:{type:String,required:!0},image_cover:{type:String,default:"default.png"},artists:{type:[String],required:!0},type:{type:String,enum:[n.LINK,n.SPOTIFY,n.UPLOAD],required:!0},duration_ms:{type:Number,required:!0,min:0},uri:{type:String,required:!1},file_id:{type:o.Schema.Types.ObjectId,required:!0},added_at:{type:Date,required:!0,default:Date.now()}});i.statics.listSongByObjId=function(e,t){return this.find({_id:{$in:e}},t)},t.Song=o.model("Song",i)},function(e,t,s){"use strict";var o=this&&this.__awaiter||function(e,t,s,o){return new(s||(s=Promise))(function(n,i){function r(e){try{d(o.next(e))}catch(e){i(e)}}function a(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){e.done?n(e.value):new s(function(t){t(e.value)}).then(r,a)}d((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const n=s(18),i=s(4),r=s(1),a=s(2),d=s(17),u=s(0),c=s(3),l=s(6),p=s(5),f=s(15),h=s(14);let y=s(13),g=s(12);t.SongController=class{constructor(e,t){this.repo=new a.Repository(n.Song),this._gridfs=t;let s=h.diskStorage({destination:function(e,t,s){s(null,"./musictmp/")},filename:function(e,t,s){"audio/mpeg"==t.mimetype||"audio/mp3"==t.mimetype?s(null,"music_"+t.originalname.toLowerCase().replace(/\s+/g,"+")):s(new Error("file is not an mp3 format"),null)}});this._upload=h({storage:s,limits:{fileSize:20971520}}),this.youtubeDownload=this.youtubeDownload.bind(this),this.pushToDb=this.pushToDb.bind(this),this.getListOfSpotifySongs=this.getListOfSpotifySongs.bind(this),this.songUpload=this.songUpload.bind(this),this.loadSong=this.loadSong.bind(this),this.streamSong=this.streamSong.bind(this),this.loadSongs=this.loadSongs.bind(this),this.deletesong=this.deletesong.bind(this),e.post("/song/ytdl",c.UserMiddleware.is_allowed,this.youtubeDownload,this.pushToDb),e.post("/song/spotifytracks",c.UserMiddleware.is_allowed,this.getListOfSpotifySongs),e.post("/song/upload",c.UserMiddleware.is_allowed,this.songUpload,this.pushToDb),e.get("/song/stream/:id",c.UserMiddleware.is_allowed,this.streamSong),e.get("/song/:id",c.UserMiddleware.is_allowed,this.loadSong),e.post("/song/list",c.UserMiddleware.is_allowed,this.loadSongs),e.post("/song/remove/:id",c.UserMiddleware.is_allowed,this.deletesong)}songUpload(e,t,s){this._upload.single("song")(e,t,o=>{if(o)return console.log(o),t.status(500).json(u.JsonResponse.error(o,500));const i=e.file,r=e.body;g(i.path,(e,o)=>{t.locals.info={duration:1e3*o,artist:r.artists.split(","),cover:r.cover,name:r.name},t.locals.codeVideo=i.path,t.locals.origin=n.SongType.UPLOAD,s()})})}youtubeDownload(e,t,s){const o=e.query.q,i=e.query.origin.toLowerCase()==n.SongType.SPOTIFY?n.SongType.SPOTIFY:n.SongType.LINK;let r=e.body;if(console.log("Downloading youtube video"),i==n.SongType.SPOTIFY&&null==r.forId)return t.status(500).json(u.JsonResponse.error("Can't download spotify song",500));p({url:"https://m.youtube.com/results?client=mv-google&hl=fr&gl=FR&q="+o+"+audio&submit=Rechercher",method:"GET",gzip:!0},(e,o,a)=>{let c=unescape(a).match(/watch\?v=(.*?)+"/)[0].match(/watch\?v=(.*?)\"/)[1],l="http://www.youtube.com/watch?v="+c;y.getInfo(l,[],(e,o)=>{if(e)throw e;let a=[];o.duration.split(":").forEach(e=>{a.push(parseInt(e))});const p=d.ArrayHelper.arrTimeToMs(a);t.locals.codeVideo=c,t.locals.origin=i,t.locals.info={duration:p,artist:r.artists?r.artists.split(","):o.uploader,name:r.name?r.name:o.title,cover:r.cover?r.cover:"https://i.ytimg.com/vi/"+c+"/maxresdefault.jpg"},i==n.SongType.SPOTIFY&&(t.locals.forId=r.forId),console.log("Downloading -> ",c," waiting..."),y.exec(l,["-x","--audio-format","mp3","-o","./musictmp/music_"+c+".mp3"],{},(e,o)=>e?t.status(500).json(u.JsonResponse.error("Can't download youtube video "+c,500)):s())})})}pushToDb(e,t,s){console.log("Done finished downloading ",t.locals.info.name);let r=this._gridfs.openUploadStream(t.locals.codeVideo,{metadata:t.locals.info});const a=t.locals.origin==n.SongType.UPLOAD?t.locals.codeVideo:"./musictmp/music_"+t.locals.codeVideo+".mp3";f.createReadStream(a).pipe(r);let d=this;f.unlink(a,s=>{if(s)return t.status(500).json(u.JsonResponse.error(s,500));r.once("finish",function(){return o(this,void 0,void 0,function*(){let s=t.locals.info.artist instanceof Array?t.locals.info.artist:[t.locals.info.artist],o=yield d.repo.create({name:t.locals.info.name,image_cover:t.locals.info.cover,artists:s,type:t.locals.origin,duration_ms:t.locals.info.duration,file_id:r.id}),a=t.locals.origin!=n.SongType.SPOTIFY?e.session.user._id:t.locals.forId;i.User.pushSong(a,o.message._id,(e,s)=>e?t.status(500).json(u.JsonResponse.error(e,500)):t.json(o))})})})}getListOfSpotifySongs(e,t,s){let o=e.body.at,n=0,i=0;p("https://api.spotify.com/v1/me/tracks?limit=50&offset="+n,{json:!0,withCredentials:!0,headers:{Authorization:"Bearer "+o}},(s,o,r)=>s||r.error?t.status(403).json(u.JsonResponse.error("Access token expired",403)):(n+=50,i=r.total,r.items.forEach(t=>{const s=t.track.artists;let o=t.track.name;s.length>0&&(o+=" "+s[0].name),o=o.replace(/\s+/g,"+");const n=s.map(e=>e.name).reduce((e,t)=>e+t+",","");console.log("Enqueuing spotify:",t.track.id," - ",o),l.SongWorker.enQueue({videoId:t.track.id,artists:n.substring(0,n.length-1),name:t.track.name,keyword:o,forId:e.session.user._id})}),t.json(u.JsonResponse.success("Downloading your last 50 songs"))))}loadSong(e,t){const s=e.params.id;n.Song.findById(s,(e,s)=>t.json(u.JsonResponse.success(s)))}loadSongs(e,t){const s=e.body;n.Song.listSongByObjId(s.data,(e,s)=>t.json(u.JsonResponse.success(s)))}streamSong(e,t){const s=e.params.id;t.set("content-type","audio/mp3"),t.set("accept-ranges","bytes");try{var o=new r.mongo.ObjectId(s)}catch(e){return t.status(400).json(u.JsonResponse.error("Incorrect ID",400))}let n=this._gridfs.openDownloadStream(o);n.on("data",e=>{t.write(e)}),n.on("error",()=>{t.sendStatus(404)}),n.on("end",()=>{t.end()})}deletesong(e,t){let s=e.params.id,o=this;n.Song.findByIdAndRemove(s,(s,n)=>{if(s)return t.status(500).json(u.JsonResponse.error(s,500));i.User.update({_id:r.Types.ObjectId(e.session.user._id)},{$pull:{song_list:r.Types.ObjectId(n._id)}},(e,s)=>{if(e)return console.log(e),t.status(500).json(u.JsonResponse.error(e,500));o._gridfs.delete(n.file_id,e=>e?(console.log(e),t.status(500).json(u.JsonResponse.error(e,500))):t.json(u.JsonResponse.success("Song deleted")))})})}}},function(e,t){e.exports=require("bcrypt")},function(e,t,s){"use strict";var o=this&&this.__awaiter||function(e,t,s,o){return new(s||(s=Promise))(function(n,i){function r(e){try{d(o.next(e))}catch(e){i(e)}}function a(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){e.done?n(e.value):new s(function(t){t(e.value)}).then(r,a)}d((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const n=s(4),i=s(2),r=s(7),a=s(0),d=s(3),u=s(20);t.UserController=class{constructor(e){this.repo=new i.Repository(n.User),this.register=this.register.bind(this),this.connexion=this.connexion.bind(this),this.logout=this.logout.bind(this),this.getCurrentSession=this.getCurrentSession.bind(this),e.post("/user/register",this.register),e.post("/user/connexion",this.connexion),e.post("/user/logout",d.UserMiddleware.is_allowed,this.logout),e.get("/user/session",d.UserMiddleware.is_allowed,this.getCurrentSession)}register(e,t){return o(this,void 0,void 0,function*(){let s=e.body;if(r.Checker.isUserValid(s)){if(void 0!=s.password){let e=u.hashSync(s.password,10);s.password=e;const o=yield this.repo.create(s);return t.json(o)}{const e=yield this.repo.create(s);return t.json(e)}}return t.json(a.JsonResponse.error("User not valid",400))})}connexion(e,t){let s=e.body;if(void 0==s.email||void 0==s.password)return t.status(500).json(a.JsonResponse.error("No email or password",400));n.User.findByMail(s.email,(o,i)=>o?t.status(400).json(a.JsonResponse.error("Mail not found",400)):i.is_connected?t.status(500).json(a.JsonResponse.error("Already connected",500)):void u.compare(s.password,i.password,(s,o)=>{if(s||!o)return t.status(400).json(a.JsonResponse.error("Incorrect password",400));n.User.findByIdAndUpdate(i._id,{is_connected:!0},(s,o)=>s?t.status(500).json(a.JsonResponse.error("Something went wrong :(",500)):(i.is_connected=!0,e.session.user=i,t.json(a.JsonResponse.success(i))))}))}getCurrentSession(e,t){return e.session.user?t.json(a.JsonResponse.success(e.session.user)):t.status(400)}logout(e,t){n.User.findByIdAndUpdate(e.session.user._id,{is_connected:!1},(s,o)=>s?t.status(500).json(a.JsonResponse.error(s,500)):(e.session.destroy(),t.json(a.JsonResponse.success("Successfull disconnect"))))}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.dbHost="localhost",e.dbPort="27017",e.dbName="webify"}(t.DBConfig||(t.DBConfig={}))},function(e,t){e.exports=require("querystring")},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=s(23);!function(e){const t="1ba80100e92d4d49870b7e4fc4931720",s="3da3164990b4482dbdeb3bc941a07466",n="http://localhost:8080/spotify-login";e.spotifyStateKey="spotify_auth_state",e.giveState=function(e){let t="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<e;o++)t+=s.charAt(Math.floor(Math.random()*s.length));return t},e.connexion=function(e,s){return o.stringify({response_type:"code",client_id:t,scope:e,redirect_uri:n,state:s})},e.authentificationOptions=function(e){return{url:"https://accounts.spotify.com/api/token",form:{code:e,redirect_uri:n,grant_type:"authorization_code"},headers:{Authorization:"Basic "+new Buffer(t+":"+s).toString("base64")},json:!0}}}(t.SpotifyConfig||(t.SpotifyConfig={}))},function(e,t,s){"use strict";var o=this&&this.__awaiter||function(e,t,s,o){return new(s||(s=Promise))(function(n,i){function r(e){try{d(o.next(e))}catch(e){i(e)}}function a(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){e.done?n(e.value):new s(function(t){t(e.value)}).then(r,a)}d((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const n=s(24),i=s(5),r=s(2),a=s(4),d=s(0);!function(e){e.spotify_login=function(e,t){let s=n.SpotifyConfig.giveState(16);t.cookie(n.SpotifyConfig.spotifyStateKey,s,{maxAge:9e5,httpOnly:!0});const o=n.SpotifyConfig.connexion("user-read-private user-read-email user-library-read",s);return t.json(o)},e.spotify_redirect=function(e,t){let s=e.query.code||null,u=e.query.state||null;e.cookies&&e.cookies[n.SpotifyConfig.spotifyStateKey];const c=new r.Repository(a.User);if(null===u)return t.json({error:"State undefined or different"});{t.clearCookie(n.SpotifyConfig.spotifyStateKey);let r=n.SpotifyConfig.authentificationOptions(s);i.post(r,function(s,n,r){if(s||200!==n.statusCode)return t.json({error:"Unvalidate token"});var u=r.access_token,l=(r.refresh_token,{url:"https://api.spotify.com/v1/me",headers:{Authorization:"Bearer "+u},json:!0});i.get(l,function(s,n,i){a.User.findByMail(i.email,(s,n)=>o(this,void 0,void 0,function*(){if(s)return t.json(d.JsonResponse.error(s,500));if(n)a.User.connexion(n._id,u,(s,o)=>(e.session.user=o,t.json(d.JsonResponse.success({user:o}))));else{let s=yield c.create({email:i.email,is_connected:!0,access_token:u,spotify_infos:{country:i.country,spotify_id:i.id,is_premium:"premium"==i.product,spotify_link:i.href,spotify_api:i.href}});if("error"==s.type)return t.status(500).json(d.JsonResponse.error("Can't create spotify user",500));e.session.user=s.message,e.session.save(e=>e?t.status(500).json(d.JsonResponse.error("Can't save session",500)):t.json(s))}}))})})}}}(t.HelperSpotify||(t.HelperSpotify={}))},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("express")},function(e,t,s){"use strict";(function(o){Object.defineProperty(t,"__esModule",{value:!0});const n=s(28),i=s(27),r=s(26),a=s(1),d=s(25),u=s(22),c=s(21),l=s(19),p=s(11),f=s(6),h=n(),y=s(9);s(8)(y);h.use(y({secret:"IOuL85f4a10lNbs",resave:!0,saveUninitialized:!0,maxAge:864e5})),h.set("port",process.env.PORT||3e3),h.set("portSocket",process.env.PORTSOCKET||4808),h.set("trust proxy",1),h.use(i.json()),h.use(n.urlencoded({extended:!0})),h.use(n.static(o+"/public")).use(r()),h.use((e,t,s)=>{t.header("Access-Control-Allow-Origin","http://localhost:8080"),t.header("Access-Control-Allow-Credentials","true"),t.header("Access-Control-Allow-Methods","GET,POST,DELETE"),t.header("Access-Control-Allow-Headers","Origin, X-Requested With, Content-Type, Accept"),s()}),a.connect("mongodb://"+u.DBConfig.dbHost+":"+u.DBConfig.dbPort+"/"+u.DBConfig.dbName),a.connection.once("open",()=>{let e=new a.mongo.GridFSBucket(a.connection.db);new c.UserController(h),new l.SongController(h,e),new p.PlaylistController(h);h.get("/spotify-login",d.HelperSpotify.spotify_login),h.get("/spotify-redirect",d.HelperSpotify.spotify_redirect),h.listen(h.get("port"),()=>{console.log("App is running at http://localhost:%d",h.get("port")),console.log("Press CTRL-C to stop\n"),f.SongWorker.initWorker()})}),e.exports=h}).call(this,"/")}]);